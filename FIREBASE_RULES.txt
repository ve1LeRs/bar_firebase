// ВАЖНО: Скопируйте эти правила в Firebase Console!
// https://console.firebase.google.com/project/bar-menu-2/firestore/rules

rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // Правила для коллекции заказов
    match /orders/{orderId} {
      // Разрешить всем читать заказы
      allow read: if true;
      
      // Разрешить всем создавать заказы
      allow create: if true;
      
      // Разрешить обновлять заказы (для webhook сервера и клиентов)
      allow update: if true;
      
      // Разрешить удалять заказы
      allow delete: if true;
    }
    
    // Правила для стоп-листа
    match /stoplist/{itemId} {
      // Разрешить всем читать стоп-лист
      allow read: if true;
      
      // Разрешить всем изменять стоп-лист
      allow write: if true;
    }
    
    // Правила для коллекции счетов (bills)
    match /bills/{billId} {
      // Разрешить пользователям читать только свои счета
      allow read: if request.auth != null && 
                     (resource.data.userId == request.auth.uid || 
                      get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin');
      
      // Разрешить создавать счета авторизованным пользователям
      allow create: if request.auth != null && request.resource.data.userId == request.auth.uid;
      
      // Разрешить обновлять свои счета или админам
      allow update: if request.auth != null && 
                       (resource.data.userId == request.auth.uid || 
                        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin');
      
      // Разрешить удалять только админам
      allow delete: if request.auth != null && 
                       get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
    }
    
    // Правила для коллекции оценок (ratings) - для будущего
    match /ratings/{ratingId} {
      // Разрешить всем читать оценки
      allow read: if true;
      
      // Разрешить создавать оценки авторизованным пользователям
      allow create: if request.auth != null;
      
      // Разрешить обновлять только свои оценки
      allow update: if request.auth != null && resource.data.userId == request.auth.uid;
      
      // Разрешить удалять только свои оценки
      allow delete: if request.auth != null && resource.data.userId == request.auth.uid;
    }
    
    // Правила для коллекции промокодов (promocodes)
    match /promocodes/{promoId} {
      // Разрешить всем читать промокоды (для проверки)
      allow read: if true;
      
      // Разрешить создавать, обновлять и удалять только админам
      allow create, update, delete: if request.auth != null && 
                                       get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
    }
    
    // Правила для коллекции ингредиентов (ingredients) - Система закупок
    match /ingredients/{ingredientId} {
      // Разрешить читать только админам
      allow read: if request.auth != null && 
                     get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
      
      // Разрешить создавать, обновлять и удалять только админам
      allow create, update, delete: if request.auth != null && 
                                       get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
    }
    
    // Правила для категорий и других коллекций
    match /{document=**} {
      // Разрешить всем читать
      allow read: if true;
      
      // Разрешить всем записывать
      allow write: if true;
    }
  }
}

